<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªëng k√™ h·ªá th·ªëng</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/CSS/statistic.css">
</head>
<body>
<div class="system-stats">
    <h2><i class="fas fa-chart-bar"></i>Th·ªëng k√™ h·ªá th·ªëng</h2>

    <!-- Cards t·ªïng quan -->
    <section>
        <h2><i class="fas fa-chart-pie"></i>T·ªïng quan</h2>
        <ul>
            <li>T·ªïng s·ªë ng∆∞·ªùi d√πng: <span th:text="${totalUsers}">0</span></li>
            <li>T·ªïng s·ªë c√¥ng ty: <span th:text="${totalCompanies}">0</span></li>
            <li>T·ªïng s·ªë CV / h·ªì s∆°: <span th:text="${totalCVs}">0</span></li>
            <li>T·ªïng s·ªë c√¥ng vi·ªác: <span th:text="${totalJobs}">0</span></li>
            <li>T·ªïng s·ªë ƒë∆°n ·ª©ng tuy·ªÉn: <span th:text="${totalApplications}">0</span></li>
            <li>T·ªïng s·ªë g√≥i Premium: <span th:text="${totalPremiumPackages}">0</span></li>
            <li>T·ªïng s·ªë h√≥a ƒë∆°n: <span th:text="${totalInvoices}">0</span></li>
            <li>T·ªïng doanh thu: <span th:text="${totalRevenue}">0</span></li>
        </ul>
    </section>

    <!-- Bi·ªÉu ƒë·ªì -->
    <section class="dashboard-section">
        <div class="chart-grid">
                <h2><i class="fas fa-chart-line"></i> Bi·ªÉu ƒë·ªì th·ªëng k√™</h2>

            <article class="chart-box">
                <h3><i class="fas fa-chart-column"></i> Bi·ªÉu ƒë·ªì 1: Ng∆∞·ªùi d√πng theo th√°ng</h3>
                <div class="chart-container">
                    <canvas id="usersChart"></canvas>
                </div>
            </article>

            <article class="chart-box">
                <h3><i class="fas fa-chart-pie"></i> Bi·ªÉu ƒë·ªì 2: ·ª®ng tuy·ªÉn theo ng√†nh</h3>
                <div class="chart-container">
                    <canvas id="applicationsByIndustryChart"></canvas>
                </div>
            </article>

            <article class="chart-box">
                <h3><i class="fas fa-chart-line"></i> Bi·ªÉu ƒë·ªì 3: Doanh thu theo th√°ng</h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </article>
        </div>
    </section>
</div>

<script>
    // H√†m l·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng theo th√°ng
    async function fetchUsersByMonth() {
        try {
            const response = await fetch('/admin/api/statistics/users-by-month');
            if (!response.ok) throw new Error('Failed to fetch users data');
            return await response.json();
        } catch (error) {
            console.error('Error fetching users by month:', error);
            return null;
        }
    }

    // H√†m l·∫•y d·ªØ li·ªáu doanh thu theo th√°ng
    async function fetchRevenueByMonth() {
        try {
            const response = await fetch('/admin/api/statistics/revenue-by-month');
            if (!response.ok) throw new Error('Failed to fetch revenue data');
            return await response.json();
        } catch (error) {
            console.error('Error fetching revenue by month:', error);
            return null;
        }
    }

    // H√†m l·∫•y d·ªØ li·ªáu ·ª©ng tuy·ªÉn theo ng√†nh
    async function fetchApplicationsByIndustry() {
        try {
            const response = await fetch('/admin/api/statistics/applications-by-industry');
            if (!response.ok) throw new Error('Failed to fetch applications data');
            return await response.json();
        } catch (error) {
            console.error('Error fetching applications by industry:', error);
            return null;
        }
    }

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì ng∆∞·ªùi d√πng theo th√°ng
    async function initUsersChart() {
        const data = await fetchUsersByMonth();
        const ctx = document.getElementById('usersChart');
        
        if (!ctx) return;
        
        const months = data?.months || ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        const counts = data?.counts || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'S·ªë ng∆∞·ªùi d√πng',
                    data: counts,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì ·ª©ng tuy·ªÉn theo ng√†nh
    async function initApplicationsByIndustryChart() {
        const data = await fetchApplicationsByIndustry();
        const ctx = document.getElementById('applicationsByIndustryChart');
        
        if (!ctx) return;
        
        const labels = data?.labels || ['Ng√†nh 1', 'Ng√†nh 2', 'Ng√†nh 3'];
        const counts = data?.counts || [0, 0, 0];
        
        const colors = [
            'rgba(255, 99, 132, 0.6)',
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(199, 199, 199, 0.6)',
            'rgba(83, 102, 255, 0.6)',
            'rgba(255, 99, 255, 0.6)',
            'rgba(99, 255, 132, 0.6)'
        ];
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'S·ªë ·ª©ng tuy·ªÉn',
                    data: counts,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: colors.slice(0, labels.length).map(c => c.replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right'
                    }
                }
            }
        });
    }

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì doanh thu theo th√°ng
    async function initRevenueChart() {
        const data = await fetchRevenueByMonth();
        const ctx = document.getElementById('revenueChart');
        
        if (!ctx) return;
        
        const months = data?.months || ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        const revenues = data?.revenues || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Doanh thu (VND)',
                    data: revenues,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN').format(value) + ' ƒë';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' ƒë';
                            }
                        }
                    }
                }
            }
        });
    }

    // H√†m kh·ªüi t·∫°o t·∫•t c·∫£ bi·ªÉu ƒë·ªì
    async function initAllCharts() {
        // ƒê·ª£i Chart.js load xong (n·∫øu ch∆∞a load)
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js ch∆∞a ƒë∆∞·ª£c load, ƒë·ª£i...');
            await new Promise(resolve => {
                const checkChart = setInterval(() => {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(checkChart);
                        resolve();
                    }
                }, 100);
                // Timeout sau 5 gi√¢y
                setTimeout(() => {
                    clearInterval(checkChart);
                    console.error('Chart.js kh√¥ng th·ªÉ load ƒë∆∞·ª£c');
                    resolve();
                }, 5000);
            });
        }
        
        // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o canvas ƒë√£ render
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Kh·ªüi t·∫°o c√°c bi·ªÉu ƒë·ªì
        await Promise.all([
            initUsersChart(),
            initApplicationsByIndustryChart(),
            initRevenueChart()
        ]);
        
        console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o t·∫•t c·∫£ bi·ªÉu ƒë·ªì');
    }

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì ngay khi script ƒë∆∞·ª£c load (khi inject qua AJAX)
    // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render v√† Chart.js ƒë√£ load
    (function() {
        // Ki·ªÉm tra xem c√≥ canvas elements kh√¥ng
        function checkAndInit() {
            const usersChart = document.getElementById('usersChart');
            if (usersChart && typeof Chart !== 'undefined') {
                console.log('üìä Ph√°t hi·ªán canvas v√† Chart.js, kh·ªüi t·∫°o bi·ªÉu ƒë·ªì...');
                initAllCharts();
                return true;
            }
            return false;
        }
        
        // Th·ª≠ ngay
        if (!checkAndInit()) {
            // N·∫øu ch∆∞a s·∫µn s√†ng, th·ª≠ l·∫°i sau 100ms
            setTimeout(() => {
                if (!checkAndInit()) {
                    // Th·ª≠ l·∫°i sau 300ms n·ªØa
                    setTimeout(() => {
                        if (!checkAndInit()) {
                            console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ kh·ªüi t·∫°o bi·ªÉu ƒë·ªì: Canvas ho·∫∑c Chart.js ch∆∞a s·∫µn s√†ng');
                        }
                    }, 300);
                }
            }, 100);
        }
        
        // L·∫Øng nghe event contentLoaded t·ª´ admin.js (backup)
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.addEventListener('contentLoaded', function() {
                console.log('üìä Nh·∫≠n ƒë∆∞·ª£c event contentLoaded, kh·ªüi t·∫°o bi·ªÉu ƒë·ªì...');
                setTimeout(initAllCharts, 100);
            });
        }
    })();
</script>
</body>
</html>