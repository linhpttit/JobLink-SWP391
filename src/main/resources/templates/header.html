<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Header MyJob</title>
    <link rel="stylesheet" th:href="@{/header.css}">
    <link rel="stylesheet" th:href="@{/homepage.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

</head>
<body>

<div th:fragment="header">
    <link rel="stylesheet" th:href="@{/header.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <!-- Auto-login loading overlay -->
    <div id="autoLoginOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 10000; justify-content: center; align-items: center;">
        <div style="text-align: center; padding: 20px; border-radius: 10px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #007bff; margin-bottom: 15px;"></i>
            <h3 style="margin: 0 0 10px 0; color: #333;" data-i18n="welcome_back">Welcome back!</h3>
            <p style="margin: 0; color: #666;" data-i18n="signing_in">Signing you in automatically...</p>
        </div>
    </div>

    <header class="header">
        <!-- Thanh top-nav -->
        <div class="top-nav">
            <div class="left-links">
                <a th:href="@{/}" href="/" data-i18n="home">Home</a>
                <a th:href="@{/search}" data-i18n="find_job">Find Job</a>
                <a href="/employers" data-i18n="employers">Employers</a>
                <a href="#" data-i18n="candidates">Candidates</a>
                <a href="#" data-i18n="pricing_plans">Pricing Plans</a>
                <a href="#" data-i18n="customer_support">Customer Supports</a>
            </div>
            <div class="right-links">
                <span class="phone-number">
                    <i class="fa-solid fa-phone"></i> +1-202-555-0178
                </span>
                <div class="language-dropdown">
                    <div class="language-selector">
                        <img id="currentLangFlag" src="https://flagcdn.com/us.svg" alt="Flag" class="flag">
                        <span id="currentLangText">English</span>
                        <span class="arrow-down">▼</span>
                    </div>
                    <div class="language-dropdown-content">
                        <a href="#" onclick="changeLanguage('en'); return false;">
                            <img src="https://flagcdn.com/us.svg" alt="English" class="flag" style="width: 24px;">
                            <span>English</span>
                        </a>
                        <a href="#" onclick="changeLanguage('vi'); return false;">
                            <img src="https://flagcdn.com/vn.svg" alt="Tiếng Việt" class="flag" style="width: 24px;">
                            <span>Tiếng Việt</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thanh main-header -->
        <div class="main-header">
            <div class="logo-section">
                <span class="logo-icon"><i class="fa-solid fa-briefcase"></i></span>
                <span class="logo-text">Joblink</span>
            </div>

            <div class="search-section">
                <div class="country-selector">
                    <img src="https://flagcdn.com/vn.svg" alt="Vietnam Flag" class="flag">
                    <span>Vietnam</span>
<!--                    <span class="arrow-down">▼</span>-->
                </div>
                <div class="search-input-container">
                    <input type="text" data-i18n-placeholder="search_placeholder" placeholder="Find job by job title, keyword, company">
                </div>
            </div>


<!--            ✅ USER MENU (chỉ hiện khi seeker đã đăng nhập)-->
            <div class="usermenu" data-menu
                 th:if="${session.user != null and #strings.equalsIgnoreCase(session.user.role, 'seeker')}">
                <button class="usermenu__btn" id="usermenuBtn" aria-haspopup="menu" aria-expanded="false">
                    <img src="src/main/resources/images/user.png" alt="user" />
                    <span class="usermenu__caret">▾</span>
                </button>

                <div class="usermenu__dropdown" role="menu" aria-labelledby="usermenuBtn" id="usermenuDropdown">
                    <div class="usermenu__header">
                        <img class="usermenu__avatar" src="images/user.png" alt="avatar">
                        <div class="usermenu__who">
                            <!-- dùng thuộc tính từ session.user -->
                            <div class="usermenu__name" th:text="${session.user.fullName}"></div>
                            <div class="usermenu__email" th:text="${session.user.email}"></div>
                        </div>
                    </div>

                    <a class="usermenu__item" href="/jobseeker/dashboard">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 3h8v8H3V3zm10 0h8v6h-8V3zM3 13h6v8H3v-8zm8 4h10v4H11v-4z" fill="currentColor"/></svg>
                        <span>Dashboard</span>
                    </a>

                    <a class="usermenu__item" href="/jobseeker/cv">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                        <span>CV Attachment</span>
                    </a>

                    <a class="usermenu__item" th:href="@{/jobseeker/profile}">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5v1h18v-1c0-2.5-4-5-9-5z" fill="currentColor"/></svg>
                        <span>Profile</span>
                    </a>

                    <a class="usermenu__item" href="/jobseeker/jobs">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M9 6V4h6v2h5a2 2 0 0 1 2 2v4H2V8a2 2 0 0 1 2-2h5zm13 6v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-6h8v1h4v-1z" fill="currentColor"/></svg>
                        <span>My Jobs</span>
                    </a>

                    <a class="usermenu__item" href="/jobseeker/invitations">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 7l9-4 9 4v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zM3 7l9 5 9-5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                        <span>Job Invitation</span>
                    </a>

                    <a class="usermenu__item" href="/subscriptions">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M4 4h16v16H4z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M4 6l8 6 8-6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                        <span>Email Subscriptions</span>
                    </a>

                    <a class="usermenu__item" href="/notifications">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2zm6-6V11a6 6 0 0 0-5-5.91V4a1 1 0 1 0-2 0v1.09A6 6 0 0 0 6 11v5l-2 2v1h16v-1l-2-2z" fill="currentColor"/></svg>
                        <span>Notifications</span>
                    </a>

                    <a class="usermenu__item" href="/settings">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M19.4 12.9a7.7 7.7 0 0 0 0-1.8l2-1.5-2-3.5-2.3.9a7.5 7.5 0 0 0-1.6-.9L15 2h-6l-.5 3.1a7.5 7.5 0 0 0-1.6.9l-2.3-.9-2 3.5 2 1.5a7.7 7.7 0 0 0 0 1.8l-2 1.5 2 3.5 2.3-.9c.5.4 1 .7 1.6.9L9 22h6l.5-3.1c.6-.2 1.1-.5 1.6-.9l2.3.9 2-3.5zM12 15.5A3.5 3.5 0 1 1 15.5 12 3.5 3.5 0 0 1 12 15.5z" fill="currentColor"/></svg>
                        <span>Settings</span>
                    </a>

                    <div class="usermenu__sep"></div>

                    <a class="usermenu__item usermenu__item--danger" href="/logout">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M10 17l5-5-5-5v3H3v4h7v3zM13 3h8v18h-8" fill="currentColor"/></svg>
                        <span>Sign Out</span>
                    </a>
                </div>
            </div>


            <div class="action-buttons">
                <a th:if="${session.user == null}" th:href="@{/signin}" class="sign-in-btn" data-i18n="sign_in">Sign In</a>
                <a th:if="${session.user != null}" th:href="@{/logout}" class="sign-in-btn" data-i18n="log_out">Log Out</a>
                <a th:if="${session.user == null}" th:href="@{/signup}" class="post-job-btn" data-i18n="post_job">Post A Job</a>
            </div>
        </div>
    </header>

    <!-- Language translations and auto-login script -->
    <script>
        // Translations object
        const translations = {
            en: {
                home: "Home",
                find_job: "Find Job",
                employers: "Employers",
                candidates: "Candidates",
                pricing_plans: "Pricing Plans",
                customer_support: "Customer Supports",
                sign_in: "Sign In",
                log_out: "Log Out",
                post_job: "Post A Job",
                search_placeholder: "Find job by job title, keyword, company",
                welcome_back: "Welcome back!",
                signing_in: "Signing you in automatically..."
            },
            vi: {
                home: "Trang chủ",
                find_job: "Tìm việc",
                employers: "Nhà tuyển dụng",
                candidates: "Ứng viên",
                pricing_plans: "Bảng giá",
                customer_support: "Hỗ trợ khách hàng",
                sign_in: "Đăng nhập",
                log_out: "Đăng xuất",
                post_job: "Đăng tin",
                search_placeholder: "Tìm việc theo tiêu đề, từ khóa, công ty",
                welcome_back: "Chào mừng trở lại!",
                signing_in: "Đang đăng nhập tự động..."
            }
        };

        // Change language function
        function changeLanguage(lang) {
            // Save language preference
            localStorage.setItem('joblink_language', lang);

            // Update flag and text
            const flagImg = document.getElementById('currentLangFlag');
            const langText = document.getElementById('currentLangText');

            if (lang === 'vi') {
                flagImg.src = 'https://flagcdn.com/vn.svg';
                langText.textContent = 'Tiếng Việt';
            } else {
                flagImg.src = 'https://flagcdn.com/us.svg';
                langText.textContent = 'English';
            }

            // Update all text elements
            applyTranslations(lang);
        }

        // Apply translations to page
        function applyTranslations(lang) {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            const placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Update HTML lang attribute
            document.documentElement.lang = lang;
        }

        // Initialize language on page load
        function initializeLanguage() {
            const savedLang = localStorage.getItem('joblink_language') || 'en';
            changeLanguage(savedLang);
        }

        // Auto-login function
        function attemptHeaderAutoLogin() {
            console.log("Checking for remembered account in header");

            const remembered = localStorage.getItem('joblink_remembered_account');
            if (!remembered) {
                console.log("No remembered account found");
                return;
            }

            try {
                const acc = JSON.parse(remembered);

                // Check expiration (14 days)
                const fourteenDays = 14 * 24 * 60 * 60 * 1000;
                if (Date.now() - acc.timestamp > fourteenDays) {
                    console.log("Remembered account expired");
                    localStorage.removeItem('joblink_remembered_account');
                    return;
                }

                // Check if already auto-logged in this session
                if (sessionStorage.getItem('joblink_auto_logged')) {
                    console.log("Already auto-logged in this session");
                    return;
                }

                // Skip if we're already on signin page
                if (window.location.pathname === '/signin') {
                    console.log("Already on signin page, skipping header auto-login");
                    return;
                }

                console.log("Attempting header auto-login for:", acc.email);

                // Show loading overlay
                const overlay = document.getElementById('autoLoginOverlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                }

                // Create form data
                const formData = new FormData();
                formData.append('email', acc.email);
                formData.append('password', acc.password);
                formData.append('remember', 'on');

                // Submit auto-login
                fetch('/login', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log("Header auto-login response status:", response.status);
                    if (response.redirected) {
                        console.log("Header auto-login successful, redirecting to:", response.url);
                        sessionStorage.setItem('joblink_auto_logged', '1');
                        window.location.href = response.url;
                    } else {
                        console.log("Header auto-login failed - no redirect");
                        if (overlay) overlay.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Header auto-login error:", error);
                    if (overlay) overlay.style.display = 'none';
                });

            } catch (e) {
                console.error("Error parsing remembered account in header:", e);
                localStorage.removeItem('joblink_remembered_account');
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language first
            initializeLanguage();

            // Then attempt auto-login
            setTimeout(attemptHeaderAutoLogin, 200);
        });

        // Clear auto-logged flag when navigating to logout
        window.addEventListener('beforeunload', function() {
            if (window.location.href.includes('/logout')) {
                sessionStorage.removeItem('joblink_auto_logged');
            }
        });
    </script>

</div>

</body>
</html>