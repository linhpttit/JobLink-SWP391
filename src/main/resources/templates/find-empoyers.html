<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Employers - JobLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/find-employers.css}">
</head>
<body>
<div th:replace="~{header :: header}"></div>

<main class="employers-main">
    <div class="page-header">
        <h1 class="page-title">Find Employers</h1>
        <div class="breadcrumb">
            <a href="/">Home</a> / <span>Find Employers</span>
        </div>
    </div>

    <div class="search-bar-container">
        <div class="search-input-group">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Job title, Keyword...">
        </div>
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" placeholder="Location">
        </div>
        <div class="search-input-group">
            <i class="fas fa-layer-group"></i>
            <select>
                <option>Select Category</option>
                <option>Design</option>
                <option>Development</option>
                <option>Marketing</option>
            </select>
        </div>
        <button class="find-job-btn">Find Job</button>
    </div>

    <div class="content-wrapper">
        <!-- Sidebar Filters -->
        <aside class="sidebar">
            <button class="filter-btn">
                <i class="fas fa-sliders-h"></i>
                Filter
            </button>

            <div class="filter-section">
                <div class="filter-title">
                    <span>Location Radius: <span class="radius-value">32 miles</span></span>
                    <i class="fas fa-chevron-up"></i>
                </div>
                <div class="radius-slider">
                    <input type="range" min="0" max="100" value="32" class="slider" id="radiusSlider">
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">
                    <span>Organization Type</span>
                    <i class="fas fa-chevron-up"></i>
                </div>
                <div class="filter-options">
                    <div class="filter-option">
                        <input type="checkbox" id="gov">
                        <label for="gov">Government</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="semi-gov">
                        <label for="semi-gov">Semi Government</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="ngo">
                        <label for="ngo">NGO</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="private">
                        <label for="private">Private Company</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="international">
                        <label for="international">International Agencies</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="others">
                        <label for="others">Others</label>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="sort-controls">
                    <select id="sortSelect">
                        <option value="most_jobs">Most Jobs</option>
                        <option value="latest">Latest</option>
                        <option value="name_az">A ‚Üí Z</option>
                        <option value="name_za">Z ‚Üí A</option>
                    </select>
                    <select id="pageSize">
                        <option value="12">12 per page</option>
                        <option value="24">24 per page</option>
                        <option value="48">48 per page</option>
                    </select>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active"><i class="fas fa-th-large"></i></button>
                    <button class="view-btn"><i class="fas fa-list"></i></button>
                </div>
            </div>

            <!-- Grid hi·ªÉn th·ªã d·ªØ li·ªáu ƒë·ªông -->
            <div class="employers-grid" id="employerGrid">
                <p style="text-align:center;width:100%;padding:40px;color:#888;">Nh·∫•n ‚ÄúFind Job‚Äù ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </div>

        <!-- JS ƒë·ªông -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const keywordInput = document.querySelector('.search-input-group input[placeholder="Job title, Keyword..."]');
                const locationInput = document.querySelector('.search-input-group input[placeholder="Location"]');
                const categorySelect = document.querySelector('.search-input-group select');
                const searchBtn = document.querySelector('.find-job-btn');
                const sortSelect = document.getElementById('sortSelect');
                const pageSizeSelect = document.getElementById('pageSize');
                const employerGrid = document.getElementById('employerGrid');
                const pagination = document.getElementById('pagination');
                const baseUrl = window.location.origin;

                let currentPage = 1;
                let totalPages = 1;

                async function fetchEmployers(page = 1) {
                    const keyword = keywordInput.value.trim();
                    const location = locationInput.value.trim();
                    const industry = categorySelect.value.trim();
                    const sort = sortSelect.value;
                    const size = pageSizeSelect.value;

                    const url = `${baseUrl}/api/employers/open?keyword=${encodeURIComponent(keyword)}&location=${encodeURIComponent(location)}&industry=${encodeURIComponent(industry)}&sort=${sort}&page=${page}&size=${size}`;
                    console.log("üîç Fetch:", url);

                    employerGrid.innerHTML = "<p style='text-align:center;width:100%;padding:40px;'>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>";
                    pagination.innerHTML = "";

                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error("L·ªói khi g·ªçi API.");
                        const data = await res.json();

                        // API tr·∫£ v·ªÅ List ho·∫∑c Page
                        const employers = data.content || data;
                        totalPages = data.totalPages || 1;
                        currentPage = data.number ? data.number + 1 : 1;

                        employerGrid.innerHTML = "";

                        if (!employers || employers.length === 0) {
                            employerGrid.innerHTML = `
                                <div style="text-align:center;width:100%;padding:40px;">
                                    <i class="fas fa-face-frown" style="font-size:3rem;color:#999;"></i>
                                    <p style="color:#999;margin-top:10px;">Kh√¥ng t√¨m th·∫•y nh√† tuy·ªÉn d·ª•ng ph√π h·ª£p.</p>
                                </div>`;
                            return;
                        }

                        employers.forEach(emp => {
                            const card = document.createElement("div");
                            card.className = "employer-card";
                            card.innerHTML = `
                                <div class="employer-info">
                                    <div class="employer-logo" style="background:#1976d2;color:#fff;">
                                        ${emp.companyName ? emp.companyName.charAt(0).toUpperCase() : "?"}
                                    </div>
                                    <div class="employer-details">
                                        <h3 class="employer-name">${emp.companyName}</h3>
                                        <div class="employer-meta">
                                            <span><i class="fas fa-map-marker-alt"></i> ${emp.location || "Kh√¥ng x√°c ƒë·ªãnh"}</span>
                                            <span><i class="fas fa-briefcase"></i> ${emp.openPositions || 0} v·ªã tr√≠ m·ªü</span>
                                        </div>
                                    </div>
                                </div>
                                <p style="margin-top:10px;font-size:14px;color:#444;">
                                    ${emp.description ? emp.description.substring(0, 150) + "..." : "Ch∆∞a c√≥ m√¥ t·∫£ c√¥ng ty."}
                                </p>
                                <button class="open-position-btn" onclick="window.location.href='/employer/${emp.employerId}'">
                                    Xem vi·ªác l√†m <i class="fas fa-arrow-right"></i>
                                </button>`;
                            employerGrid.appendChild(card);
                        });

                        renderPagination();
                    } catch (err) {
                        console.error(err);
                        employerGrid.innerHTML = `
                            <p style="text-align:center;width:100%;padding:40px;color:red;">
                                ‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh√† tuy·ªÉn d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i!
                            </p>`;
                    }
                }

                function renderPagination() {
                    pagination.innerHTML = "";

                    if (totalPages <= 1) return;

                    const createBtn = (page, label, disabled = false, active = false) => {
                        const btn = document.createElement("button");
                        btn.className = "pagination-btn" + (active ? " active" : "");
                        btn.innerHTML = label;
                        btn.disabled = disabled;
                        btn.onclick = () => fetchEmployers(page);
                        return btn;
                    };

                    pagination.appendChild(createBtn(currentPage - 1, '<i class="fas fa-chevron-left"></i>', currentPage === 1));

                    for (let i = 1; i <= totalPages; i++) {
                        pagination.appendChild(createBtn(i, i.toString(), false, i === currentPage));
                    }

                    pagination.appendChild(createBtn(currentPage + 1, '<i class="fas fa-chevron-right"></i>', currentPage === totalPages));
                }

                // G·∫Øn s·ª± ki·ªán
                searchBtn.addEventListener("click", () => fetchEmployers(1));
            });
        </script>
    </div>
</main>
</body>
</html>