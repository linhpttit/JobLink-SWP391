    <!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý gói Premium</title>
    <link rel="stylesheet" href="/CSS/premium.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div class="packages-management">
    <div class="header">
        <h2><i class="fa-solid fa-dollar-sign"></i>Quản lý gói dịch vụ Premium</h2>
        <button class="btn btn-primary" id="addPackageBtn"><i class="fas fa-plus"></i> Tạo gói mới</button>
    </div>

    <div class="filters">
        <input type="text" id="searchInput" placeholder="Tìm theo tên, code..." 
               th:value="${search != null ? search : ''}">
        <select id="statusSelect">
            <option value="" th:selected="${status == null or status == ''}">Tất cả trạng thái</option>
            <option value="active" th:selected="${status == 'active'}">Đang hoạt động</option>
            <option value="inactive" th:selected="${status == 'inactive'}">Không hoạt động</option>
        </select>
    </div>

    <!-- Table wrapper để reload -->
    <div id="table-wrapper">
        <div th:fragment="table">
            <div class="table-container">
        <table class="packages-table">
            <thead>
            <tr>
                <th>Mã gói</th>
                <th>Tên gói</th>
                <th>Giá</th>
                <th>Thời gian (ngày)</th>
                <th>Hạn mức job</th>
                <th>Nâng cao nổi bật</th>
                <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${packages == null or #lists.isEmpty(packages)}" class="no-data">
                <td colspan="7" style="text-align:center; padding: 20px; color: #888;">
                    Không có dữ liệu
                </td>
            </tr>
            <tr th:each="pkg : ${packages}">
                <td th:text="${pkg.code}">-</td>
                <td th:text="${pkg.name}">-</td>
                <td th:text="${#numbers.formatDecimal(pkg.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">-</td>
                <td th:text="${pkg.durationDays}">-</td>
                <td th:text="${pkg.maxActiveJobs != null ? pkg.maxActiveJobs : 'Không giới hạn'}">-</td>
                <td>
                    <span th:if="${pkg.highlight != null and pkg.highlight}"
                          style="background-color: #D1FAE5;
                            color: #10B981;
                            border: 1px solid #A7F3D0;">
                       Có
                    </span>
                    <span th:if="${pkg.highlight == null or !pkg.highlight}"
                          style="background-color: #FEE2E2;
                            color: #EF4444;
                            border: 1px solid #FECACA;">
                        Không
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-edit edit-package-btn" 
                            th:data-id="${pkg.packageId}" 
                            title="Chỉnh sửa">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-delete delete-package-btn" 
                            th:data-id="${pkg.packageId}"
                            th:classappend="${pkg.isActive == null or !pkg.isActive} ? 'disabled' : ''"
                            th:disabled="${pkg.isActive == null or !pkg.isActive}"
                            title="Xóa">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info">
                    <span th:if="${total != null and total > 0}">
                        Hiển thị 
                        <span th:text="${currentPage * size + 1}">0</span>
                        -
                        <span th:text="${(currentPage + 1) * size > total ? total : (currentPage + 1) * size}">0</span>
                        của 
                        <span th:text="${total}">0</span>
                        kết quả
                    </span>
                    <span th:if="${total == null or total == 0}">
                        Không có kết quả
                    </span>
                </div>
                <div class="pagination-controls" th:if="${totalPages != null and totalPages > 0}">
                    <!-- Previous button -->
                    <button type="button" class="pagination-btn pagination-prev" 
                            th:disabled="${currentPage == 0}"
                            th:data-page="${currentPage - 1}">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    
                    <!-- Page numbers -->
                    <span th:if="${totalPages != null and totalPages > 0}">
                        <!-- Hiển thị tất cả các trang nếu <= 7 trang -->
                        <span th:if="${totalPages <= 7}">
                            <button type="button" class="pagination-btn pagination-page" 
                                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                    th:data-page="${i}"
                                    th:class="${i == currentPage ? 'pagination-btn active' : 'pagination-btn'}"
                                    th:text="${i + 1}">1</button>
                        </span>
                        <!-- Hiển thị rút gọn nếu > 7 trang -->
                        <span th:if="${totalPages > 7}">
                            <!-- Trang đầu -->
                            <button type="button" class="pagination-btn pagination-page" 
                                    th:data-page="0"
                                    th:class="${currentPage == 0 ? 'pagination-btn active' : 'pagination-btn'}"
                                    th:text="1">1</button>
                            <!-- Dấu ... nếu currentPage > 3 -->
                            <span th:if="${currentPage > 3}">
                                <button class="pagination-btn" disabled>...</button>
                            </span>
                            <!-- Các trang xung quanh currentPage -->
                            <span th:each="i : ${#numbers.sequence(
                                currentPage > 3 ? currentPage - 1 : 1, 
                                currentPage < totalPages - 4 ? currentPage + 1 : totalPages - 2
                            )}">
                                <button type="button" class="pagination-btn pagination-page" 
                                        th:data-page="${i}"
                                        th:class="${i == currentPage ? 'pagination-btn active' : 'pagination-btn'}"
                                        th:text="${i + 1}"></button>
                            </span>
                            <!-- Dấu ... nếu currentPage < totalPages - 4 -->
                            <span th:if="${currentPage < totalPages - 4}">
                                <button class="pagination-btn" disabled>...</button>
                            </span>
                            <!-- Trang cuối -->
                            <button type="button" class="pagination-btn pagination-page" 
                                    th:data-page="${totalPages - 1}"
                                    th:class="${currentPage == totalPages - 1 ? 'pagination-btn active' : 'pagination-btn'}"
                                    th:text="${totalPages}"></button>
                        </span>
                    </span>
                    
                    <!-- Next button -->
                    <button type="button" class="pagination-btn pagination-next" 
                            th:data-page="${currentPage + 1}"
                            th:disabled="${currentPage == null or totalPages == null or currentPage >= totalPages - 1}">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

<!-- Edit Package Modal -->
<div id="editPackageModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="modalTitle"><i class="fa-solid fa-pen"></i> Chỉnh sửa gói Premium</h3>
            <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editPackageForm">
                <input type="hidden" id="editPackageId" name="packageId">
                <div class="form-group">
                    <label for="editCode">Mã gói <span class="required-star">*</span></label>
                    <input type="text" id="editCode" name="code" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editName">Tên gói <span class="required-star">*</span></label>
                    <input type="text" id="editName" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editUserType">Loại người dùng <span class="required-star">*</span></label>
                    <select id="editUserType" name="userType" class="form-control" required>
                        <option value="JOBSEEKER">JOBSEEKER</option>
                        <option value="EMPLOYER">EMPLOYER</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPrice">Giá (VNĐ) <span class="required-star">*</span></label>
                    <input type="number" id="editPrice" name="price" class="form-control" step="1000" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editDurationDays">Thời gian (ngày) <span class="required-star">*</span></label>
                    <input type="number" id="editDurationDays" name="durationDays" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label for="editMaxActiveJobs">Hạn mức job (để trống = không giới hạn)</label>
                    <input type="number" id="editMaxActiveJobs" name="maxActiveJobs" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label for="editBoostCredits">Boost Credits</label>
                    <input type="number" id="editBoostCredits" name="boostCredits" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label for="editCandidateViews">Candidate Views</label>
                    <input type="number" id="editCandidateViews" name="candidateViews" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editHighlight" name="highlight"> Nâng cao nổi bật
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editCvTemplatesAccess" name="cvTemplatesAccess"> CV Templates Access
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editMessagingEnabled" name="messagingEnabled"> Messaging Enabled
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editSeekerNetworkingEnabled" name="seekerNetworkingEnabled"> Seeker Networking Enabled
                    </label>
                </div>
                <div class="form-group">
                    <label for="editPdfExportLimit">PDF Export Limit</label>
                    <input type="number" id="editPdfExportLimit" name="pdfExportLimit" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label for="editFeatures">Features</label>
                    <textarea id="editFeatures" name="features" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editIsActive" name="isActive" checked> Đang hoạt động
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="modalCancelBtn">Hủy</button>
            <button type="button" class="btn btn-primary" id="modalSaveBtn">
                <i class="fa-solid fa-save"></i> Lưu
            </button>
        </div>
    </div>
</div>


<script>
(function() {
    const searchInput = document.getElementById('searchInput');
    const statusSelect = document.getElementById('statusSelect');
    const tableWrapper = document.getElementById('table-wrapper');
    
    let currentPage = 0;
    
    function reloadTable(page) {
        if (page !== undefined) currentPage = page;
        const search = searchInput.value.trim();
        const status = statusSelect.value;
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (status) params.append('status', status);
        params.append('page', currentPage);
        params.append('size', 5);
        
        fetch('/admin/premium/table?' + params.toString())
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const fragment = doc.body.querySelector('div') || doc.body;
                if (fragment) {
                    tableWrapper.innerHTML = fragment.innerHTML;
                    // Re-bind events sau khi reload table
                    bindEditButtons();
                    bindDeleteButtons();
                    // Không cần attach pagination listeners vì đã dùng event delegation ở tableWrapper level
                } else {
                    tableWrapper.innerHTML = html;
                    bindEditButtons();
                    bindDeleteButtons();
                    // Không cần attach pagination listeners vì đã dùng event delegation ở tableWrapper level
                }
            })
            .catch(error => {
                console.error('Error loading table:', error);
                tableWrapper.innerHTML = '<div style="text-align:center; padding: 20px; color: #f00;">Lỗi khi tải dữ liệu</div>';
            });
    }
    
    // Attach pagination listeners - sử dụng event delegation ở tableWrapper level
    // Chỉ cần attach một lần, không cần attach lại mỗi lần reload
    tableWrapper.addEventListener('click', function(e) {
        const btn = e.target.closest('.pagination-page, .pagination-prev, .pagination-next');
        if (!btn || btn.disabled) return;
        e.preventDefault();
        const page = parseInt(btn.getAttribute('data-page')) || 0;
        reloadTable(page);
    });
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Bind edit buttons
    function bindEditButtons() {
        document.querySelectorAll('.edit-package-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.dataset.bound = 'true';
            btn.addEventListener('click', function() {
                const packageId = this.dataset.id;
                openEditModal(packageId);
            });
        });
    }
    
    // Bind delete buttons
    function bindDeleteButtons() {
        document.querySelectorAll('.delete-package-btn').forEach(btn => {
            if (btn.dataset.bound) return;
            btn.dataset.bound = 'true';
            btn.addEventListener('click', function() {
                if (this.disabled || this.classList.contains('disabled')) return;
                const packageId = this.dataset.id;
                if (confirm('Bạn có chắc chắn muốn xóa gói này?')) {
                    softDeletePackage(packageId);
                }
            });
        });
    }
    
    // Mở modal thêm mới
    function openAddModal() {
        document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-plus"></i> Tạo gói Premium mới';
        document.getElementById('editPackageId').value = '';
        document.getElementById('editCode').value = '';
        document.getElementById('editName').value = '';
        document.getElementById('editUserType').value = 'JOBSEEKER';
        document.getElementById('editPrice').value = '';
        document.getElementById('editDurationDays').value = '';
        document.getElementById('editMaxActiveJobs').value = '';
        document.getElementById('editBoostCredits').value = '';
        document.getElementById('editCandidateViews').value = '';
        document.getElementById('editHighlight').checked = false;
        document.getElementById('editCvTemplatesAccess').checked = false;
        document.getElementById('editMessagingEnabled').checked = false;
        document.getElementById('editSeekerNetworkingEnabled').checked = false;
        document.getElementById('editPdfExportLimit').value = '';
        document.getElementById('editFeatures').value = '';
        document.getElementById('editIsActive').checked = true;
        document.getElementById('editPackageModal').style.display = 'flex';
    }
    
    // Mở modal edit
    function openEditModal(packageId) {
        document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> Chỉnh sửa gói Premium';
        fetch('/admin/premium/' + packageId)
            .then(response => {
                if (!response.ok) throw new Error('Không tìm thấy gói');
                return response.json();
            })
            .then(pkg => {
                document.getElementById('editPackageId').value = pkg.packageId;
                document.getElementById('editCode').value = pkg.code || '';
                document.getElementById('editName').value = pkg.name || '';
                document.getElementById('editUserType').value = pkg.userType || 'JOBSEEKER';
                document.getElementById('editPrice').value = pkg.price || 0;
                document.getElementById('editDurationDays').value = pkg.durationDays || 0;
                document.getElementById('editMaxActiveJobs').value = pkg.maxActiveJobs || '';
                document.getElementById('editBoostCredits').value = pkg.boostCredits || '';
                document.getElementById('editCandidateViews').value = pkg.candidateViews || '';
                document.getElementById('editHighlight').checked = pkg.highlight || false;
                document.getElementById('editCvTemplatesAccess').checked = pkg.cvTemplatesAccess || false;
                document.getElementById('editMessagingEnabled').checked = pkg.messagingEnabled || false;
                document.getElementById('editSeekerNetworkingEnabled').checked = pkg.seekerNetworkingEnabled || false;
                document.getElementById('editPdfExportLimit').value = pkg.pdfExportLimit || '';
                document.getElementById('editFeatures').value = pkg.features || '';
                document.getElementById('editIsActive').checked = pkg.isActive !== null ? pkg.isActive : true;
                document.getElementById('editPackageModal').style.display = 'flex';
            })
            .catch(err => {
                console.error('Lỗi khi load package:', err);
                alert('Không thể tải thông tin gói: ' + err.message);
            });
    }
    
    // Đóng modal
    function closeEditModal() {
        document.getElementById('editPackageModal').style.display = 'none';
        document.getElementById('editPackageForm').reset();
    }
    
    // Lưu package (create hoặc update)
    function savePackage() {
        const form = document.getElementById('editPackageForm');
        const formData = new FormData(form);
        const packageId = document.getElementById('editPackageId').value;
        const isEdit = packageId && packageId !== '';
        
        // Validation
        if (!formData.get('code') || !formData.get('name') || !formData.get('price') || !formData.get('durationDays')) {
            alert('Vui lòng điền đầy đủ các trường bắt buộc');
            return;
        }
        
        const params = new URLSearchParams();
        params.append('code', formData.get('code'));
        params.append('name', formData.get('name'));
        params.append('userType', formData.get('userType'));
        params.append('price', formData.get('price'));
        params.append('durationDays', formData.get('durationDays'));
        if (formData.get('maxActiveJobs')) params.append('maxActiveJobs', formData.get('maxActiveJobs'));
        if (formData.get('boostCredits')) params.append('boostCredits', formData.get('boostCredits'));
        if (formData.get('candidateViews')) params.append('candidateViews', formData.get('candidateViews'));
        params.append('highlight', document.getElementById('editHighlight').checked);
        params.append('cvTemplatesAccess', document.getElementById('editCvTemplatesAccess').checked);
        params.append('messagingEnabled', document.getElementById('editMessagingEnabled').checked);
        params.append('seekerNetworkingEnabled', document.getElementById('editSeekerNetworkingEnabled').checked);
        if (formData.get('pdfExportLimit')) params.append('pdfExportLimit', formData.get('pdfExportLimit'));
        if (formData.get('features')) params.append('features', formData.get('features'));
        params.append('isActive', document.getElementById('editIsActive').checked);
        
        const url = isEdit ? '/admin/premium/update/' + packageId : '/admin/premium/create';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || (isEdit ? 'Cập nhật thành công' : 'Tạo gói thành công'));
                closeEditModal();
                // Giữ nguyên trang hiện tại sau khi edit, reset về trang 0 sau khi create
                if (!isEdit) currentPage = 0;
                reloadTable();
            } else {
                alert('Lỗi: ' + (data.error || (isEdit ? 'Không thể cập nhật' : 'Không thể tạo gói')));
            }
        })
        .catch(err => {
            console.error('Lỗi:', err);
            alert('Có lỗi xảy ra: ' + (isEdit ? 'khi cập nhật' : 'khi tạo gói'));
        });
    }
    
    // Soft delete package
    function softDeletePackage(packageId) {
        fetch('/admin/premium/delete/' + packageId, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Xóa thành công');
                // Giữ nguyên trang hiện tại sau khi xóa
                reloadTable();
            } else {
                alert('Lỗi: ' + (data.error || 'Không thể xóa'));
            }
        })
        .catch(err => {
            console.error('Lỗi:', err);
            alert('Có lỗi xảy ra khi xóa');
        });
    }
    
    // Bind modal events
    const modal = document.getElementById('editPackageModal');
    const closeBtn = document.getElementById('modalCloseBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const saveBtn = document.getElementById('modalSaveBtn');
    
    if (closeBtn) closeBtn.addEventListener('click', closeEditModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeEditModal);
    if (saveBtn) saveBtn.addEventListener('click', savePackage);
    
    // Đóng modal khi click vào overlay
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEditModal();
            }
        });
    }
    
    // Đóng modal khi nhấn ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
            closeEditModal();
        }
    });
    
    const debouncedReload = debounce(function() {
        currentPage = 0;
        reloadTable();
    }, 300);
    
    searchInput.addEventListener('input', debouncedReload);
    statusSelect.addEventListener('change', function() {
        currentPage = 0;
        reloadTable();
    });
    
    // Bind nút tạo mới
    const addBtn = document.getElementById('addPackageBtn');
    if (addBtn) {
        addBtn.addEventListener('click', openAddModal);
    }
    
    // Bind events lần đầu
    bindEditButtons();
    bindDeleteButtons();
    // Pagination listeners đã được attach ở tableWrapper level, không cần gọi attachPaginationListeners()
})();
</script>
</body>
</html>