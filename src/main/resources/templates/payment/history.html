<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử thanh toán - JobLink</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/CSS/payment-history.css}">
</head>
<body>
    <!-- Include Header -->
    <div th:replace="~{header :: header}"></div>

    <div class="history-container">
        <div class="history-header">
            <h1><i class="fas fa-history"></i> Lịch sử thanh toán</h1>
            <div class="header-actions">
                <a th:href="@{/payment/upgrade}" class="btn-upgrade-new">
                    <i class="fas fa-plus-circle"></i> Nâng cấp tài khoản
                </a>
            </div>
        </div>

        <!-- Current Subscription Info -->
        <div class="subscription-status" th:if="${currentTier != null}">
            <div class="status-card">
                <div class="status-header">
                    <i class="fas fa-info-circle"></i> Thông tin gói hiện tại
                </div>
                <div class="status-body">
                    <div class="status-item">
                        <span class="label">Tier hiện tại:</span>
                        <span class="value">
                            <span class="tier-badge-new" th:classappend="${currentTier == 0 ? 'tier-free' : (currentTier == 1 ? 'tier-standard' : (currentTier == 2 ? 'tier-pro' : 'tier-premium'))}">
                                <i class="fas fa-crown"></i>
                                <strong th:text="${currentTier == 0 ? 'Free' : (currentTier == 1 ? 'Standard' : (currentTier == 2 ? 'Pro' : 'Premium'))}">Premium</strong>
                            </span>
                        </span>
                    </div>
                    <div class="status-item" th:if="${currentTier != null && currentTier > 0}">
                        <span class="label">Gói hiện tại:</span>
                        <span class="value package-name" th:text="${currentTier == 1 ? 'STANDARD' : (currentTier == 2 ? 'PRO' : 'PREMIUM (AI Talent Suite)')}">PRO</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Trạng thái:</span>
                        <span class="value">
                            <span th:if="${isSubscriptionActive}" class="badge-active-new">
                                <i class="fas fa-check-circle"></i> Đang hoạt động
                            </span>
                            <span th:unless="${isSubscriptionActive}" class="badge-expired-new">
                                <i class="fas fa-times-circle"></i> Đã hết hạn
                            </span>
                        </span>
                    </div>
                    <div class="status-item" th:if="${subscriptionExpiresAt != null}">
                        <span class="label">Ngày hết hạn:</span>
                        <span class="value" th:text="${#temporals.format(subscriptionExpiresAt, 'dd/MM/yyyy HH:mm')}">10/01/2026 23:57</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History Table -->
        <div class="transactions-section">
            <h2><i class="fas fa-receipt"></i> Lịch sử giao dịch</h2>
            
            <div th:if="${transactions == null || transactions.isEmpty()}" class="no-transactions">
                <i class="fas fa-inbox"></i>
                <p>Chưa có giao dịch nào</p>
                <a th:href="@{/payment/upgrade}" class="btn-start">
                    <i class="fas fa-rocket"></i> Bắt đầu nâng cấp
                </a>
            </div>

            <div th:if="${transactions != null && !transactions.isEmpty()}" class="table-responsive">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>MÃ GD</th>
                            <th>GÓI DỊCH VỤ</th>
                            <th>NGÀY ĐĂNG KÝ</th>
                            <th>SỐ TIỀN</th>
                            <th>TRẠNG THÁI</th>
                            <th>HẠN SỬ DỤNG</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="transaction : ${transactions}">
                            <td>
                                <span class="transaction-id" th:text="${transaction.vnpayTxnRef}">#20251109A</span>
                            </td>
                            <td>
                                <span class="package-badge" 
                                      th:classappend="${transaction.tierUpgradedTo == 1 ? 'badge-standard' : (transaction.tierUpgradedTo == 2 ? 'badge-pro' : 'badge-premium')}"
                                      th:text="${transaction.tierUpgradedTo == 1 ? 'STANDARD' : (transaction.tierUpgradedTo == 2 ? 'PRO' : 'PREMIUM')}">
                                    PREMIUM
                                </span>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy')}">09/11/2025</span>
                            </td>
                            <td>
                                <span class="amount" th:text="${#numbers.formatDecimal(transaction.amount, 0, 'COMMA', 0, 'POINT') + ' đ'}">1,300,000 đ</span>
                            </td>
                            <td>
                                <div class="status-wrapper">
                                    <span class="status-label" 
                                          th:classappend="${transaction.paymentStatus == 'SUCCESS' ? 'status-success' : (transaction.paymentStatus == 'PENDING' ? 'status-pending' : (transaction.paymentStatus == 'CANCELLED' ? 'status-cancelled' : 'status-failed'))}">
                                        <span th:text="${transaction.paymentStatus == 'SUCCESS' ? 'Thành công' : (transaction.paymentStatus == 'PENDING' ? 'Chờ xử lý' : (transaction.paymentStatus == 'CANCELLED' ? 'Giao dịch Đã Hủy' : 'Thẻ không hợp lệ'))}">Thành công</span>
                                    </span>
                                    <small class="status-code" th:text="'Code: ' + ${transaction.vnpayResponseCode != null ? transaction.vnpayResponseCode : '00'}">Code: 00</small>
                                </div>
                            </td>
                            <td>
                                <!-- SUCCESS: Tính ngày hết hạn = paidAt + durationDays -->
                                <div class="expiry-wrapper" th:if="${transaction.paymentStatus == 'SUCCESS' && transaction.paidAt != null}">
                                    <span class="expiry-date" 
                                          th:with="expiryDate=${transaction.paidAt.plusDays(transaction.subscriptionPackage.durationDays)}"
                                          th:text="${#temporals.format(expiryDate, 'dd/MM/yyyy')}">12/11/2025</span>
                                    <small class="expiry-status" 
                                           th:with="expiryDate=${transaction.paidAt.plusDays(transaction.subscriptionPackage.durationDays)},daysLeft=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDateTime).now(), expiryDate)}"
                                           th:classappend="${daysLeft > 0 ? 'expiry-active' : 'expiry-expired'}"
                                           th:text="${daysLeft > 0 ? 'Còn ' + daysLeft + ' ngày để gia hạn.' : 'Đã hết hạn'}">
                                        Còn 1 ngày để gia hạn.
                                    </small>
                                </div>
                                <!-- CANCELLED -->
                                <div class="expiry-wrapper" th:if="${transaction.paymentStatus == 'CANCELLED'}">
                                    <span class="expiry-date" th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy')}">09/11/2025</span>
                                    <small class="expiry-status expiry-expired">Đã hết hạn</small>
                                </div>
                                <!-- FAILED -->
                                <div class="expiry-wrapper" th:if="${transaction.paymentStatus == 'FAILED'}">
                                    <span class="expiry-date" th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy')}">28/11/2025</span>
                                    <small class="expiry-status expiry-failed">-</small>
                                </div>
                                <!-- PENDING -->
                                <div class="expiry-wrapper" th:if="${transaction.paymentStatus == 'PENDING'}">
                                    <span class="expiry-date" th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy')}">10/10/2025</span>
                                    <small class="expiry-status expiry-expired">Đã hết hạn</small>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-section" th:if="${transactions != null && !transactions.isEmpty()}">
            <div class="summary-card">
                <i class="fas fa-shopping-cart"></i>
                <div class="summary-info">
                    <span class="summary-label">Tổng giao dịch</span>
                    <span class="summary-value" th:text="${transactions.size()}">5</span>
                </div>
            </div>
            <div class="summary-card">
                <i class="fas fa-check-circle"></i>
                <div class="summary-info">
                    <span class="summary-label">Thành công</span>
                    <span class="summary-value" th:text="${successCount}">3</span>
                </div>
            </div>
            <div class="summary-card">
                <i class="fas fa-coins"></i>
                <div class="summary-info">
                    <span class="summary-label">Tổng chi tiêu</span>
                    <span class="summary-value" th:text="${#numbers.formatDecimal(totalSpent, 0, 'COMMA', 0, 'POINT') + ' đ'}">1,497,000 đ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Footer -->
    <div th:replace="~{footer :: footer}"></div>
</body>
</html>
